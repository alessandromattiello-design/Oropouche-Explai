import React, { useState, useEffect, useRef } from 'react';
import {
  AlertTriangle, MapPin, CheckCircle, Info, Shield, Bug,
  Thermometer, Activity, X, BookOpen, Microscope, GraduationCap,
  ArrowRight, ChevronLeft, Brain, Gamepad2, Trophy, Star, Sparkles, Heart, Globe, MessageCircle, Send, Loader2, Play, Building2, Dna, Users, Handshake
} from 'lucide-react';

// Import Firebase
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "firebase/auth";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection } from "firebase/firestore";

// --- Configuration ---
const apiKey = "";

// --- Custom Logo Components (Per i Loghi Istituzionali) ---
// Usiamo i file locali come richiesto nel "restore point".
// Nota: Questi si vedranno solo quando i file saranno nella cartella public del tuo PC.
const LogosSection = () => (
  <div className="flex flex-wrap justify-center gap-4 opacity-90">
    <div className="bg-white/90 p-2 rounded-lg h-16 flex items-center shadow-lg px-4 border border-gray-100">
      <img src="./IMG_0994.jpeg" alt="Logo 1" className="h-full w-auto object-contain" />
    </div>
    <div className="bg-white/90 p-2 rounded-lg h-16 flex items-center shadow-lg px-4 border border-gray-100">
      <img src="./IMG_0997.jpeg" alt="Logo 2" className="h-full w-auto object-contain" />
    </div>
    <div className="bg-white/90 p-2 rounded-lg h-16 flex items-center shadow-lg px-4 border border-gray-100">
      <img src="./IMG_0263.png" alt="Logo 3" className="h-full w-auto object-contain" />
    </div>
  </div>
);

// --- Intro Video Component ---
const IntroOverlay = ({ onComplete }) => {
  return (
    <div className="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center text-white animate-fadeIn">
      <div className="relative w-full h-full flex items-center justify-center bg-gray-900 overflow-hidden">
        {/* Fallback background */}
        <div className="absolute inset-0 bg-gradient-to-br from-green-900 to-teal-900 opacity-80"></div>
        <video
          autoPlay
          muted
          loop
          playsInline
          className="absolute inset-0 w-full h-full object-cover opacity-50 mix-blend-overlay"
          src="https://assets.mixkit.co/videos/preview/mixkit-green-tropical-forest-trees-drone-view-37552-large.mp4"
        />

        <div className="relative z-10 flex flex-col items-center justify-center text-center px-4 max-w-4xl">
          <div className="mb-6 animate-bounce">
            <Shield className="w-24 h-24 text-teal-400 drop-shadow-[0_0_15px_rgba(45,212,191,0.5)]" />
          </div>
          <h1 className="text-5xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-green-400 mb-6 tracking-tighter drop-shadow-2xl">
            OROPOUCHE EXPLAINED
          </h1>
          <p className="text-xl md:text-3xl text-gray-100 mb-10 font-light max-w-2xl drop-shadow-md">
            An interactive journey to learn, prevent, and protect our community.
          </p>

          <button
            onClick={onComplete}
            className="group relative px-8 py-4 bg-white text-teal-900 font-black text-lg rounded-full hover:bg-teal-400 hover:text-white transition-all duration-300 shadow-[0_0_20px_rgba(45,212,191,0.5)] hover:shadow-[0_0_40px_rgba(45,212,191,0.8)] flex items-center gap-3"
          >
            ENTER SITE
            <ArrowRight className="w-6 h-6 group-hover:translate-x-1 transition-transform" />
          </button>

          <div className="mt-16">
            <LogosSection />
          </div>
        </div>
      </div>
    </div>
  );
};

// --- UI Components ---
const Card = ({ children, className = "", noPadding = false }) => (
  <div className={`bg-white rounded-2xl shadow-xl overflow-hidden transition-transform hover:scale-[1.01] ${className}`}>
    <div className={`${noPadding ? "" : "p-6"} h-full`}>
      {children}
    </div>
  </div>
);

const Button = ({ children, onClick, variant = "primary", className = "", disabled = false, size = "md" }) => {
  const baseStyle = "rounded-xl font-bold transition-all duration-200 transform active:scale-95 flex items-center justify-center gap-2 shadow-sm";
  const sizes = { sm: "px-3 py-1.5 text-sm", md: "px-5 py-3", lg: "px-8 py-4 text-lg" };
  const variants = {
    primary: "bg-gradient-to-r from-teal-500 to-teal-700 text-white hover:shadow-teal-200 hover:shadow-lg",
    secondary: "bg-gradient-to-r from-orange-400 to-orange-600 text-white hover:shadow-orange-200 hover:shadow-lg",
    accent: "bg-gradient-to-r from-purple-500 to-indigo-600 text-white hover:shadow-indigo-200 hover:shadow-lg",
    outline: "border-2 border-teal-600 text-teal-700 hover:bg-teal-50",
    ghost: "text-gray-600 hover:bg-gray-100 bg-transparent shadow-none",
    game: "bg-yellow-400 text-yellow-900 hover:bg-yellow-300 border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1",
    ai: "bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white hover:shadow-purple-200 hover:shadow-lg border border-white/20"
  };
  return <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${sizes[size]} ${variants[variant]} ${disabled ? 'opacity-50 cursor-not-allowed grayscale' : ''} ${className}`}>{children}</button>;
};

// --- Mini-Game: Vector Hunt ---
const VectorHuntGame = ({ onExit }) => {
  const [score, setScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(30);
  const [gameState, setGameState] = useState('idle');
  const [grid, setGrid] = useState(Array(9).fill(null));
  const [feedback, setFeedback] = useState(null);

  useEffect(() => {
    let timer;
    let spawner;
    if (gameState === 'playing') {
      timer = setInterval(() => {
        setTimeLeft((prev) => {
          if (prev <= 1) {
            setGameState('gameOver');
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
      spawner = setInterval(() => {
        setGrid(prevGrid => {
          const newGrid = [...prevGrid];
          if (Math.random() > 0.5) {
            const cleanIndex = Math.floor(Math.random() * 9);
            newGrid[cleanIndex] = null;
          }
          const emptyIndices = newGrid.map((val, idx) => val === null ? idx : null).filter(val => val !== null);
          if (emptyIndices.length > 0) {
            const randomSlot = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
            const type = Math.random() > 0.3 ? 'enemy' : 'friend';
            newGrid[randomSlot] = { type, id: Date.now() };
          }
          return newGrid;
        });
      }, 600);
    }
    return () => { clearInterval(timer); clearInterval(spawner); };
  }, [gameState]);

  const handleHit = (index, item) => {
    if (!item) return;
    if (item.type === 'enemy') {
      setScore(s => s + 10);
      setFeedback({ index, type: 'good' });
      setGrid(prev => { const newG = [...prev]; newG[index] = null; return newG; });
    } else {
      setScore(s => Math.max(0, s - 5));
      setFeedback({ index, type: 'bad' });
    }
    setTimeout(() => setFeedback(null), 300);
  };

  const startGame = () => {
    setScore(0);
    setTimeLeft(30);
    setGrid(Array(9).fill(null));
    setGameState('playing');
  };

  return (
    <div className="max-w-md mx-auto animate-fadeIn">
      <Card className="bg-gradient-to-b from-indigo-900 to-purple-900 border-4 border-indigo-400 text-white relative overflow-hidden">
        <div className="flex justify-between items-center mb-4 bg-black/30 p-3 rounded-xl backdrop-blur-sm">
          <div className="flex items-center gap-2">
            <Trophy className="text-yellow-400 w-6 h-6 animate-pulse" />
            <span className="font-mono text-2xl font-bold text-yellow-400">{score}</span>
          </div>
          <div className="font-bold text-xl font-mono bg-red-600 px-3 py-1 rounded shadow-inner border border-red-400">
            00:{timeLeft < 10 ? `0${timeLeft}` : timeLeft}
          </div>
        </div>

        {gameState === 'idle' && (
          <div className="text-center py-10 space-y-6">
            <Gamepad2 className="w-20 h-20 mx-auto text-indigo-300" />
            <h2 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-pink-500">
              VECTOR HUNT
            </h2>
            <p className="text-indigo-200 px-4">
              Tap the <span className="text-red-400 font-bold">Midges (Enemies)</span> to eliminate them.<br/>
              Don't touch the <span className="text-green-400 font-bold">Hearts (Friends)</span>!
            </p>
            <Button onClick={startGame} variant="game" size="lg" className="mx-auto w-full max-w-xs text-xl">
              START GAME
            </Button>
          </div>
        )}

        {gameState === 'playing' && (
          <div className="grid grid-cols-3 gap-3 p-2 bg-indigo-950/50 rounded-xl">
            {grid.map((item, i) => (
              <div
                key={i}
                onClick={() => handleHit(i, item)}
                className={`
                  aspect-square rounded-xl flex items-center justify-center cursor-pointer transition-all active:scale-90 relative
                  ${!item ? 'bg-indigo-800/40' : 'bg-indigo-700 shadow-lg border-b-4 border-indigo-900'}
                  ${feedback?.index === i && feedback.type === 'bad' ? 'bg-red-500' : ''}
                  ${feedback?.index === i && feedback.type === 'good' ? 'bg-green-500' : ''}
                `}
              >
                {item?.type === 'enemy' && (
                  <Bug className="w-10 h-10 text-red-400 drop-shadow-lg animate-bounce" />
                )}
                {item?.type === 'friend' && (
                  <Heart className="w-10 h-10 text-green-400 drop-shadow-lg animate-pulse fill-current" />
                )}
                {feedback?.index === i && (
                  <div className="absolute inset-0 flex items-center justify-center font-black text-xl z-10 animate-ping">
                    {feedback.type === 'good' ? '+10' : '-5'}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}

        {gameState === 'gameOver' && (
          <div className="text-center py-10 space-y-6">
            <Star className="w-20 h-20 mx-auto text-yellow-400 animate-spin-slow" />
            <h2 className="text-3xl font-bold text-white">GAME OVER!</h2>
            <p className="text-xl">Final Score: <span className="text-yellow-400 font-bold text-2xl">{score}</span></p>
            <div className="flex flex-col gap-3 px-6">
              <Button onClick={startGame} variant="game" size="lg">
                Play Again
              </Button>
              <Button onClick={onExit} variant="ghost" className="text-indigo-200 hover:bg-indigo-800">
                Exit to Menu
              </Button>
            </div>
          </div>
        )}
      </Card>

      {gameState === 'idle' && (
        <div className="text-center mt-4">
          <Button onClick={onExit} variant="ghost">Go Back</Button>
        </div>
      )}
    </div>
  );
};

// --- Educational Modules ---
// Updated with REAL Visible Images from Wikimedia Commons (Reliable & High Quality)
const educationalModules = [
  {
    id: 'virus',
    title: 'The Virus & Its History',
    // 1st Image: Virus Family (Microscope)
    image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/Bunyaviridae_virions.jpg/640px-Bunyaviridae_virions.jpg',
    icon: <Microscope className="w-6 h-6" />,
    color: 'bg-purple-100 text-purple-700',
    content: (
      <div className="space-y-4">
        <h3 className="text-xl font-bold text-gray-800">What is Oropouche (OROV)?</h3>
        <p>Oropouche is an arbovirus belonging to the <i>Peribunyaviridae</i> family (genus <i>Orthobunyavirus</i>). It was first isolated in 1955 in Trinidad, near the Oropouche River, from a febrile forest worker.</p>

        <h4 className="font-bold text-gray-800 mt-4 text-lg">Transmission Cycles</h4>
        <div className="grid md:grid-cols-2 gap-4 mt-2">
          <div className="bg-purple-50 p-4 rounded-lg">
            <strong className="block text-purple-900 mb-1">Sylvatic Cycle (Jungle)</strong>
            <p className="text-sm text-gray-700">The virus circulates between primates (monkeys), sloths, and birds, transmitted by forest mosquitoes like <i>Coquillettidia venezuelensis</i>.</p>
          </div>
          <div className="bg-purple-50 p-4 rounded-lg">
            <strong className="block text-purple-900 mb-1">Urban Cycle (Epidemic)</strong>
            <p className="text-sm text-gray-700">Humans act as the "amplifying host". The virus is transmitted from person to person primarily by the biting midge <i>Culicoides paraensis</i>.</p>
          </div>
        </div>

        <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200 mt-4 flex gap-4 items-center">
          <span className="text-4xl">üåç</span>
          <div>
            <h4 className="font-bold text-blue-800">Geographic Expansion</h4>
            <p className="text-sm text-blue-700">Originally confined to the Amazon basin, the virus is now expanding across South America and has been detected in travelers returning to Europe.</p>
          </div>
        </div>
      </div>
    ),
    quiz: [
      { q: "Which family does the Oropouche virus belong to?", options: ["Flaviviridae (like Dengue)", "Peribunyaviridae", "Coronaviridae"], correct: 1 },
      { q: "What is the primary animal host in the jungle?", options: ["Sloths and Primates", "Domestic Dogs", "Fish"], correct: 0 },
      { q: "When was the virus first isolated?", options: ["2024", "1955", "1800"], correct: 1 }
    ]
  },
  {
    id: 'vector',
    title: 'The Vector: Culicoides',
    // 2nd Image: The Midge (Culicoides)
    image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Culicoides_impunctatus.jpg/640px-Culicoides_impunctatus.jpg',
    icon: <Bug className="w-6 h-6" />,
    color: 'bg-teal-100 text-teal-700',
    content: (
      <div className="space-y-4">
        <h3 className="text-xl font-bold text-gray-800">Know Your Enemy: <i>Culicoides paraensis</i></h3>
        <p>The primary vector is NOT a common mosquito, but a tiny biting midge (often called "no-see-ums" or "maruim"). They are significantly smaller than <i>Aedes aegypti</i>.</p>

        <div className="grid grid-cols-2 gap-3 mt-4">
          <div className="bg-orange-50 p-3 rounded-lg border border-orange-200">
            <h4 className="font-bold text-orange-800 text-sm mb-1">Habitat</h4>
            <p className="text-xs text-gray-700">They breed in <strong>decaying organic matter</strong>: cacao hulls, banana stumps, and moist soil rich in organic waste.</p>
          </div>
          <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
            <h4 className="font-bold text-blue-800 text-sm mb-1">Behavior</h4>
            <p className="text-xs text-gray-700">They are diurnal (active during the day) and crepuscular (dawn/dusk). They are tiny (1-3mm) and can pass through standard nets.</p>
          </div>
        </div>

        <p className="text-sm italic text-gray-500 mt-2">Note: While <i>Culex quinquefasciatus</i> mosquitoes can also carry the virus, the midge is the primary driver of urban epidemics.</p>
      </div>
    ),
    quiz: [
      { q: "How large is the Culicoides midge?", options: ["Huge", "Tiny (1-3mm)", "Same as a house fly"], correct: 1 },
      { q: "Where do they prefer to lay eggs?", options: ["Clean water", "Decaying organic matter", "Dry sand"], correct: 1 },
      { q: "Can they pass through standard mosquito nets?", options: ["Yes, they are very small", "No, they are too big"], correct: 0 }
    ]
  },
  {
    id: 'symptoms',
    title: 'Symptoms & Diagnosis',
    // 3rd Image: Fever/Thermometer
    image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/Fever_thermometer.jpg/640px-Fever_thermometer.jpg',
    icon: <Thermometer className="w-6 h-6" />,
    color: 'bg-red-100 text-red-700',
    content: (
      <div className="space-y-4">
        <h3 className="text-xl font-bold text-gray-800">Clinical Presentation</h3>
        <p>The incubation period is 4‚Äì8 days. Onset is sudden and can be easily confused with Dengue, Zika, or Chikungunya.</p>

        <div className="flex flex-wrap gap-2 mt-2">
          {["High Fever (>39¬∞C)", "Intense Headache", "Photophobia (Light Sensitivity)", "Dizziness", "Joint Pain"].map(s => (
            <span key={s} className="bg-white border border-gray-200 px-3 py-1 rounded-full text-sm shadow-sm font-medium text-gray-700">{s}</span>
          ))}
        </div>

        <div className="bg-red-50 p-4 rounded-xl mt-4 border-l-4 border-red-500">
          <h4 className="font-bold text-red-800 flex items-center gap-2"><AlertTriangle className="w-4 h-4"/> The "Rebound" Effect</h4>
          <p className="text-sm text-red-700 mt-1">A unique characteristic of Oropouche is <strong>recurrence</strong>. In about 60% of cases, symptoms return 1‚Äì2 weeks after recovery. This is rare in Dengue.</p>
        </div>

        <p className="text-sm text-gray-600"><strong>Severe Cases:</strong> Although rare, the virus can cause aseptic meningitis or meningoencephalitis. Medical attention is crucial for accurate diagnosis (PCR test).</p>
      </div>
    ),
    quiz: [
      { q: "Which symptom helps distinguish it from mild Dengue?", options: ["Extreme hunger", "Photophobia & Dizziness", "Cough"], correct: 1 },
      { q: "What is the 'rebound' effect?", options: ["Never getting sick again", "Symptoms returning after recovery", "Immunity"], correct: 1 },
      { q: "What is the incubation period?", options: ["24 hours", "4-8 days", "1 month"], correct: 1 }
    ]
  },
  {
    id: 'prevention',
    title: 'Prevention & Control',
    // 4th Image: Mosquito Net
    image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Mosquito_net_01.jpg/640px-Mosquito_net_01.jpg',
    icon: <Shield className="w-6 h-6" />,
    color: 'bg-green-100 text-green-700',
    content: (
      <div className="space-y-4">
        <h3 className="text-xl font-bold text-gray-800">Community Defense Strategy</h3>
        <p>There is currently no vaccine. Prevention relies entirely on vector control and personal protection.</p>

        <ul className="space-y-3 mt-4">
          <li className="flex items-start gap-3 bg-white p-3 rounded-lg shadow-sm">
            <div className="bg-green-100 p-2 rounded-full mt-1">üß¥</div>
            <div>
              <span className="font-bold text-gray-800 block">Repellents</span>
              <span className="text-sm text-gray-600">Use DEET, Picaridin, or IR3535. Apply to exposed skin and clothing.</span>
            </div>
          </li>
          <li className="flex items-start gap-3 bg-white p-3 rounded-lg shadow-sm">
            <div className="bg-green-100 p-2 rounded-full mt-1">üï∏Ô∏è</div>
            <div>
              <span className="font-bold text-gray-800 block">Fine-Mesh Nets</span>
              <span className="text-sm text-gray-600">Standard mosquito nets are ineffective. Use ultra-fine mesh treated with insecticide.</span>
            </div>
          </li>
          <li className="flex items-start gap-3 bg-white p-3 rounded-lg shadow-sm">
            <div className="bg-green-100 p-2 rounded-full mt-1">üóëÔ∏è</div>
            <div>
              <span className="font-bold text-gray-800 block">Source Reduction</span>
              <span className="text-sm text-gray-600">Remove breeding sites: rotting fruit, cacao husks, and organic waste piles near homes.</span>
            </div>
          </li>
        </ul>
      </div>
    ),
    quiz: [
      { q: "Which repellent is recommended?", options: ["Perfume", "DEET or Picaridin", "Sugar water"], correct: 1 },
      { q: "What is 'Source Reduction'?", options: ["Cleaning organic waste/breeding sites", "Closing windows", "Running away"], correct: 0 },
      { q: "Do standard mosquito nets work well?", options: ["Yes, perfectly", "No, midges can pass through", "Only if blue"], correct: 1 }
    ]
  }
];

// --- AI Chat Component ---
// Modified to accept props for persistence
const AIChatAssistant = ({ messages, setMessages }) => {
  const [inputText, setInputText] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const callGemini = async (prompt) => {
    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: {
              parts: [{ text: "You are Dr. Z, an expert AI assistant for the 'Oropouche Explained' app. Your goal is to provide complete and exhaustive answers, but keep them simple, concise, and easy to understand. Explain scientific concepts clearly without unnecessary complexity. Ensure all key information regarding Oropouche virus, vectors, symptoms, and prevention is covered efficiently. Respond in the same language as the user's question." }]
            }
          })
        }
      );
      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "I'm having trouble connecting to the lab right now. Try again later!";
    } catch (error) {
      console.error("AI Error:", error);
      return "My communication link is down. Please check your connection.";
    }
  };

  const handleSend = async () => {
    if (!inputText.trim() || isLoading) return;

    const userMsg = inputText;
    setInputText('');
    setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
    setIsLoading(true);

    const aiResponse = await callGemini(userMsg);

    setMessages(prev => [...prev, { role: 'model', text: aiResponse }]);
    setIsLoading(false);
  };

  return (
    <div className="max-w-2xl mx-auto h-[600px] flex flex-col animate-fadeIn">
      <Card className="flex-1 bg-slate-50 relative border-2 border-indigo-100" noPadding>
        <div className="flex flex-col h-full">
          {/* Header */}
          <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 flex items-center gap-3 text-white shadow-md z-10 shrink-0">
            <div className="bg-white/20 p-2 rounded-full">
              <Sparkles className="w-6 h-6 text-yellow-300" />
            </div>
            <div>
              <h3 className="font-bold text-lg">Dr. Z - Virtual Expert</h3>
              <p className="text-xs text-indigo-100">Your Personal Guide</p>
            </div>
          </div>

          {/* Chat Area */}
          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            {messages.map((msg, idx) => (
              <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[80%] rounded-2xl p-4 shadow-sm ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-100 rounded-bl-none'}`}>
                  {msg.text}
                </div>
              </div>
            ))}
            {isLoading && (
              <div className="flex justify-start">
                <div className="bg-white p-3 rounded-2xl rounded-bl-none shadow-sm border border-gray-100 flex items-center gap-2 text-gray-500 text-sm">
                  <Loader2 className="w-4 h-4 animate-spin text-indigo-500" /> Dr. Z is thinking...
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Input Area */}
          <div className="p-4 bg-white border-t border-gray-100 shrink-0">
            <div className="flex gap-2">
              <input
                type="text"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                placeholder="Ask about symptoms, prevention..."
                className="flex-1 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all"
              />
              <Button onClick={handleSend} variant="ai" className="px-4" disabled={isLoading}>
                <Send className="w-5 h-5" />
              </Button>
            </div>
          </div>
        </div>
      </Card>
    </div>
  );
};

// Componente Principale
export default function App() {
  const [showIntro, setShowIntro] = useState(true);
  const [activeTab, setActiveTab] = useState('home');
  const [viewCount, setViewCount] = useState(null);
  const [user, setUser] = useState(null);
  const [appId, setAppId] = useState(null);

  // Stati Accademia
  const [activeModule, setActiveModule] = useState(null);
  const [moduleMode, setModuleMode] = useState('info');
  const [currentQuizIndex, setCurrentQuizIndex] = useState(0);
  const [quizScore, setQuizScore] = useState(0);
  const [completedModules, setCompletedModules] = useState([]);

  // Stato Chat Persistente
  const [chatMessages, setChatMessages] = useState([
    { role: 'model', text: "Hi! I'm Dr. Z, your Oropouche expert. Ask me anything about the virus, symptoms, or how to stay safe! ‚ú®" }
  ]);

  // --- FIREBASE INIT ---
  useEffect(() => {
    // Controllo se siamo in ambiente preview con la config disponibile
    if (typeof __firebase_config === 'undefined') {
      console.log("Firebase config missing (local/export mode). View counter disabled.");
      return;
    }

    try {
      const firebaseConfig = JSON.parse(__firebase_config);
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      setAppId(currentAppId);

      // Auth
      const initAuth = async () => {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          try {
            await signInWithCustomToken(auth, __initial_auth_token);
          } catch (e) {
            console.error("Custom token sign-in failed, falling back to anon:", e);
            await signInAnonymously(auth);
          }
        } else {
          await signInAnonymously(auth);
        }
      };
      initAuth();
      const unsubscribe = onAuthStateChanged(auth, setUser);
      return () => unsubscribe();
    } catch (e) {
      console.error("Firebase init error:", e);
    }
  }, []);

  // --- VIEW COUNTER LOGIC ---
  useEffect(() => {
    if (!user || !appId) return;

    const db = getFirestore();
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'site_stats', 'summary');

    // 1. Ascolta aggiornamenti (Realtime view count)
    const unsubscribe = onSnapshot(docRef, (snap) => {
      if (snap.exists()) {
        setViewCount(snap.data().views || 0);
      } else {
        setViewCount(0);
      }
    }, (error) => {
      console.error("Error fetching view count:", error);
    });

    // 2. Incrementa (Solo una volta per sessione browser per non falsare troppo)
    const hasViewed = sessionStorage.getItem('hasViewedSite');
    if (!hasViewed) {
      sessionStorage.setItem('hasViewedSite', 'true');

      getDoc(docRef).then((snap) => {
        if (snap.exists()) {
          updateDoc(docRef, { views: (snap.data().views || 0) + 1 }).catch(e => console.warn("Update failed", e));
        } else {
          setDoc(docRef, { views: 1 }).catch(e => console.warn("Set failed", e));
        }
      }).catch(e => console.warn("Get failed (offline)", e));
    }

    return () => unsubscribe();
  }, [user, appId]);


  // Se l'intro √® attiva, mostra solo quella
  if (showIntro) {
    return <IntroOverlay onComplete={() => setShowIntro(false)} />;
  }

  // Funzioni Navigazione
  const openModule = (moduleId) => {
    setActiveModule(moduleId);
    setModuleMode('info');
    setCurrentQuizIndex(0);
    setQuizScore(0);
  };

  const startQuiz = () => {
    setModuleMode('quiz');
    setCurrentQuizIndex(0);
    setQuizScore(0);
  };

  const handleQuizAnswer = (answerIndex) => {
    const currentModule = educationalModules.find(m => m.id === activeModule);
    const isCorrect = answerIndex === currentModule.quiz[currentQuizIndex].correct;

    if (isCorrect) setQuizScore(prev => prev + 1);

    if (currentQuizIndex < currentModule.quiz.length - 1) {
      setCurrentQuizIndex(prev => prev + 1);
    } else {
      setModuleMode('result');
      const finalScore = quizScore + (isCorrect ? 1 : 0);
      if (finalScore === currentModule.quiz.length) {
        if (!completedModules.includes(activeModule)) {
          setCompletedModules(prev => [...prev, activeModule]);
        }
      }
    }
  };

  const backToAcademy = () => {
    setActiveModule(null);
    setModuleMode('info');
  };

  // Rendering Accademia
  const renderAcademy = () => {
    if (!activeModule) {
      return (
        <div className="space-y-8 animate-fadeIn">
          <div className="text-center">
            <h2 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-purple-600 mb-2">
              Explorer Academy
            </h2>
            <p className="text-gray-600">Collect all badges to become an Expert!</p>

            {/* Progress Bar */}
            <div className="max-w-md mx-auto mt-6 bg-gray-200 rounded-full h-6 relative overflow-hidden shadow-inner">
              <div
                className="bg-gradient-to-r from-yellow-400 to-orange-500 h-full transition-all duration-1000 ease-out"
                style={{ width: `${(completedModules.length / educationalModules.length) * 100}%` }}
              ></div>
              <div className="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-700">
                {completedModules.length} / {educationalModules.length} MISSIONS COMPLETED
              </div>
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-6">
            {educationalModules.map((mod) => (
              <Card key={mod.id} noPadding className="cursor-pointer group h-full flex flex-col" onClick={() => openModule(mod.id)}>
                <div
                  className="h-40 bg-cover bg-center relative group-hover:scale-105 transition-transform duration-500"
                  style={{ backgroundImage: `url(${mod.image})` }}
                >
                  <div className="absolute inset-0 bg-black/30 group-hover:bg-black/10 transition-colors"></div>
                  {completedModules.includes(mod.id) && (
                    <div className="absolute top-4 right-4 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full font-bold shadow-lg flex items-center gap-1 animate-bounce">
                      <Trophy className="w-4 h-4" /> Completed!
                    </div>
                  )}
                </div>
                <div className="p-6 flex-1 flex flex-col" onClick={() => openModule(mod.id)}>
                  <div className="flex items-center gap-3 mb-3">
                    <div className={`p-2 rounded-lg ${mod.color}`}>{mod.icon}</div>
                    <h3 className="text-xl font-bold text-gray-800">{mod.title}</h3>
                  </div>
                  <p className="text-gray-500 text-sm mb-4 flex-1">Discover the secrets and pass the test to earn the badge.</p>
                  <div className="flex justify-end">
                    <Button size="sm" variant="ghost" className="text-teal-600 group-hover:translate-x-1">
                      Start Mission <ArrowRight className="w-4 h-4" />
                    </Button>
                  </div>
                </div>
              </Card>
            ))}
          </div>
        </div>
      );
    }

    const currentModData = educationalModules.find(m => m.id === activeModule);

    if (moduleMode === 'info') {
      return (
        <div className="max-w-3xl mx-auto animate-fadeIn pb-10">
          <Button variant="ghost" onClick={backToAcademy} className="mb-4 -ml-4">
            <ChevronLeft className="w-5 h-5" /> Back
          </Button>

          <div className="rounded-3xl overflow-hidden shadow-2xl mb-8 relative">
            <img src={currentModData.image} alt={currentModData.title} className="w-full h-64 object-cover" />
            <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-8 pt-20">
              <h2 className="text-4xl font-bold text-white mb-2">{currentModData.title}</h2>
              <div className="flex items-center gap-2 text-white/90">
                {currentModData.icon} Educational Module
              </div>
            </div>
          </div>

          <Card className="mb-8 border-t-4 border-teal-500">
            <div className="prose prose-lg text-gray-700 max-w-none">
              {currentModData.content}
            </div>
          </Card>

          <div className="bg-gradient-to-r from-teal-600 to-cyan-600 p-8 rounded-3xl text-center text-white shadow-xl relative overflow-hidden">
            <Sparkles className="absolute top-4 right-4 text-yellow-300 w-12 h-12 opacity-50 animate-pulse" />
            <h4 className="text-2xl font-bold mb-3">Are you ready for the challenge?</h4>
            <p className="mb-6 opacity-90">Answer {currentModData.quiz.length} questions correctly to win the badge!</p>
            <Button onClick={startQuiz} variant="secondary" size="lg" className="mx-auto shadow-xl hover:scale-110">
              <Brain className="w-5 h-5" /> START QUIZ
            </Button>
          </div>
        </div>
      );
    }

    if (moduleMode === 'quiz') {
      const question = currentModData.quiz[currentQuizIndex];
      return (
        <div className="max-w-xl mx-auto animate-fadeIn py-8">
          <Card className="border-4 border-teal-100">
            <div className="flex justify-between items-center mb-8">
              <span className="font-bold text-teal-600 uppercase tracking-widest text-sm">Question {currentQuizIndex + 1} of {currentModData.quiz.length}</span>
              <div className="flex gap-1">
                {currentModData.quiz.map((_, i) => (
                  <div key={i} className={`h-2 w-8 rounded-full ${i <= currentQuizIndex ? 'bg-teal-500' : 'bg-gray-200'}`}></div>
                ))}
              </div>
            </div>

            <h3 className="text-2xl font-bold text-gray-800 mb-8 leading-snug">{question.q}</h3>

            <div className="space-y-4">
              {question.options.map((opt, idx) => (
                <button
                  key={idx}
                  onClick={() => handleQuizAnswer(idx)}
                  className="w-full text-left p-5 rounded-xl border-2 border-gray-100 hover:border-teal-500 hover:bg-teal-50 transition-all font-bold text-gray-700 text-lg hover:shadow-md transform hover:-translate-y-1"
                >
                  {opt}
                </button>
              ))}
            </div>
          </Card>
        </div>
      );
    }

    if (moduleMode === 'result') {
      const isPerfect = quizScore === currentModData.quiz.length;
      return (
        <div className="max-w-lg mx-auto text-center py-12 animate-fadeIn">
          <Card className={`border-t-8 ${isPerfect ? 'border-green-500' : 'border-orange-500'}`}>
            <div className="mb-6 relative inline-block">
              {isPerfect ? (
                <>
                  <div className="absolute inset-0 bg-yellow-400 blur-xl opacity-50 animate-pulse"></div>
                  <Trophy className="w-24 h-24 text-yellow-500 relative z-10 mx-auto drop-shadow-md" />
                </>
              ) : (
                <div className="bg-orange-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto">
                  <Activity className="w-12 h-12 text-orange-500" />
                </div>
              )}
            </div>

            <h3 className="text-3xl font-black text-gray-800 mb-2">
              {isPerfect ? 'MISSION ACCOMPLISHED!' : 'ALMOST THERE!'}
            </h3>
            <p className="text-gray-500 mb-8 text-lg">
              You scored <span className="font-bold text-gray-800">{quizScore}</span> out of {currentModData.quiz.length} points
            </p>

            {isPerfect ? (
              <div className="bg-green-50 text-green-800 p-6 rounded-xl mb-8 font-medium">
                Fantastic! You earned the <span className="font-bold">{currentModData.title}</span> badge.
              </div>
            ) : (
              <div className="bg-orange-50 text-orange-800 p-6 rounded-xl mb-8 font-medium">
                Don't give up! Read the lesson again and retry to earn the badge.
              </div>
            )}

            <div className="flex flex-col gap-3">
              <Button onClick={backToAcademy} variant={isPerfect ? "primary" : "outline"} className="w-full">
                {isPerfect ? "Continue Adventure" : "Back to Map"}
              </Button>
              {!isPerfect && (
                <Button onClick={startQuiz} variant="primary" className="w-full">Try Again</Button>
              )}
            </div>
          </Card>
        </div>
      );
    }
  };

  const renderContent = () => {
    switch(activeTab) {
      case 'home':
        return (
          <div className="space-y-10 animate-fadeIn">
            {/* Hero Section */}
            <div className="relative rounded-3xl overflow-hidden shadow-2xl text-center md:text-left bg-gray-900">
              <img
                src="https://images.unsplash.com/photo-1542259681-d4193d56d498?auto=format&fit=crop&w=1200&q=80"
                alt="Nature Background"
                className="absolute inset-0 w-full h-full object-cover opacity-40"
              />
              <div className="relative z-10 p-8 md:p-16 flex flex-col md:flex-row items-center gap-8">
                <div className="flex-1">
                  <div className="inline-block bg-teal-500 text-white text-xs font-bold px-3 py-1 rounded-full mb-4 tracking-widest">EDUCATIONAL PROJECT</div>
                  <h1 className="text-4xl md:text-6xl font-black text-white mb-6 leading-tight">
                    Stop the <span className="text-teal-400">Midge</span>,<br/>Save the City!
                  </h1>
                  <p className="text-gray-200 text-lg mb-8 max-w-lg">
                    Join the Oropouche Explained team. Learn to recognize the enemy, play the game, and protect your neighborhood.
                  </p>
                  <div className="flex flex-wrap gap-4 justify-center md:justify-start">
                    <Button onClick={() => setActiveTab('game')} variant="secondary" size="lg" className="animate-pulse">
                      <Gamepad2 className="w-6 h-6" /> PLAY NOW
                    </Button>
                    <Button onClick={() => setActiveTab('academy')} variant="primary" size="lg">
                      <BookOpen className="w-6 h-6" /> START LEARNING
                    </Button>
                    <Button onClick={() => setActiveTab('ask-ai')} variant="ai" size="lg">
                      <Sparkles className="w-6 h-6" /> ASK THE EXPERT
                    </Button>
                  </div>
                </div>
                {/* Mascot placeholder/Icon */}
                <div className="hidden md:block">
                  <div className="w-48 h-48 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center border-4 border-white/20 shadow-2xl">
                    <Shield className="w-24 h-24 text-teal-400" />
                  </div>
                </div>
              </div>
            </div>

            {/* Feature Cards */}
            <div className="grid md:grid-cols-3 gap-6">
              {[
                { title: "Learn & Play", desc: "Interactive modules with real scientific data.", icon: <GraduationCap />, color: "bg-purple-500", action: () => setActiveTab('academy') },
                { title: "Arcade Zone", desc: "Train your reflexes against vectors.", icon: <Gamepad2 />, color: "bg-orange-500", action: () => setActiveTab('game') },
                { title: "Ask Dr. Z", desc: "Chat with our virus expert.", icon: <MessageCircle />, color: "bg-indigo-500", action: () => setActiveTab('ask-ai') }
              ].map((feature, idx) => (
                <div key={idx} onClick={feature.action} className="bg-white p-5 rounded-2xl shadow-lg cursor-pointer hover:-translate-y-2 transition-transform group">
                  <div className={`${feature.color} w-12 h-12 rounded-2xl flex items-center justify-center text-white mb-4 shadow-md group-hover:scale-110 transition-transform`}>
                    {React.cloneElement(feature.icon, { className: "w-6 h-6" })}
                  </div>
                  <h3 className="text-lg font-bold text-gray-800 mb-1">{feature.title}</h3>
                  <p className="text-gray-500 text-sm">{feature.desc}</p>
                </div>
              ))}
            </div>
          </div>
        );

      case 'game':
        return <VectorHuntGame onExit={() => setActiveTab('home')} />;

      case 'academy':
        return renderAcademy();

      case 'ask-ai':
        // Pass the state and setter from App to persist chat
        return <AIChatAssistant messages={chatMessages} setMessages={setChatMessages} />;

      default:
        return null;
    }
  };

  return (
    <div className="min-h-screen bg-slate-100 font-sans text-slate-900 pb-10 selection:bg-teal-200 selection:text-teal-900 animate-fadeIn">
      {/* Navbar Playful */}
      <nav className="bg-white shadow-lg sticky top-0 z-50 border-b-4 border-teal-500">
        <div className="max-w-6xl mx-auto px-4">
          <div className="flex justify-between items-center h-20">

            {/* LOGO SECTION - Modificata per inserire immagini */}
            <div className="flex items-center gap-6 cursor-pointer transform hover:scale-105 transition-transform" onClick={() => setActiveTab('home')}>
              {/* Logo Progetto */}
              <div className="flex items-center gap-2">
                <div className="w-10 h-10 bg-gradient-to-br from-teal-400 to-teal-600 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg rotate-3">OE</div>
                <span className="font-black text-2xl text-gray-800 tracking-tight hidden sm:block">
                  Oropouche<span className="text-teal-600">Explained</span>
                </span>
              </div>

              {/* Separatore */}
              <div className="h-8 w-px bg-gray-300 hidden md:block"></div>

              {/* AREA LOGHI PARTNER (HEADER) */}
              <div className="hidden md:flex items-center gap-4">
                {/* Logo Buonarroti */}
                <div className="bg-white px-2 py-1 rounded border border-gray-100 flex items-center shadow-sm gap-2">
                  <img src="./IMG_0994.jpeg" alt="Logo 1" className="h-8 w-auto object-contain" />
                </div>
                {/* Logo Viruskenner */}
                <div className="bg-white px-2 py-1 rounded border border-gray-100 flex items-center shadow-sm gap-2">
                  <img src="./IMG_0997.jpeg" alt="Logo 2" className="h-8 w-auto object-contain" />
                </div>
                {/* Logo 3 (Header) */}
                <div className="bg-white px-2 py-1 rounded border border-gray-100 flex items-center shadow-sm gap-2">
                  <img src="./IMG_0263.png" alt="Logo 3" className="h-8 w-auto object-contain" />
                </div>
              </div>
            </div>

            <div className="flex gap-2">
              {[
                { id: 'home', icon: Info, label: 'Home' },
                { id: 'game', icon: Gamepad2, label: 'Play' },
                { id: 'academy', icon: GraduationCap, label: 'Learn' },
                { id: 'ask-ai', icon: MessageCircle, label: 'Ask Dr. Z' }
              ].map((tab) => (
                <button
                  key={tab.id}
                  onClick={() => { setActiveTab(tab.id); if(tab.id === 'academy') backToAcademy(); }}
                  className={`flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 px-3 sm:px-4 py-2 rounded-xl transition-all font-bold text-xs sm:text-sm
                    ${activeTab === tab.id
                      ? 'bg-teal-50 text-teal-700 transform scale-105'
                      : 'text-gray-400 hover:bg-gray-100 hover:text-gray-600'}`}
                >
                  <tab.icon className={`w-5 h-5 ${activeTab === tab.id ? 'stroke-[2.5px]' : ''}`} />
                  <span className="hidden sm:inline">{tab.label}</span>
                </button>
              ))}
            </div>
          </div>
        </div>
      </nav>

      {/* Main Content Area */}
      <main className="max-w-6xl mx-auto px-4 py-8">
        {renderContent()}
      </main>

      {/* Footer con Sezione Loghi */}
      <footer className="mt-auto bg-white border-t border-gray-200">
        <div className="max-w-6xl mx-auto px-4 py-12">
          <div className="grid md:grid-cols-2 gap-8 items-center mb-8">
            <div className="text-left">
              <h4 className="font-black text-gray-800 text-lg mb-2">IN COLLABORATION WITH</h4>
              <p className="text-gray-500 text-sm mb-4">Project supported by scientific and educational institutions.</p>

              {/* AREA LOGHI PARTNER (FOOTER) */}
              <div className="flex flex-wrap gap-4 opacity-80">
                <div className="bg-white px-2 py-1 rounded border border-gray-100 flex items-center shadow-sm gap-2">
                  <img src="./IMG_0994.jpeg" alt="Logo 1" className="h-8 w-auto object-contain" />
                </div>
                <div className="bg-white px-2 py-1 rounded border border-gray-100 flex items-center shadow-sm gap-2">
                  <img src="./IMG_0997.jpeg" alt="Logo 2" className="h-8 w-auto object-contain" />
                </div>
                <div className="bg-white px-2 py-1 rounded border border-gray-100 flex items-center shadow-sm gap-2">
                  <img src="./IMG_0263.png" alt="Logo 3" className="h-8 w-auto object-contain" />
                </div>
              </div>
            </div>

            <div className="text-center md:text-right space-y-4">
              <div className="inline-flex items-center gap-2 opacity-80 cursor-pointer">
                <div className="w-8 h-8 bg-teal-600 rounded-lg flex items-center justify-center text-white font-bold">OE</div>
                <span className="font-bold text-gray-700">Oropouche Explained Team</span>
              </div>
              <p className="text-gray-400 text-sm whitespace-pre-line">
                Made with ‚ù§Ô∏è for public safety. <br/>Remember: prevention is better than cure!
              </p>

              {/* Visualizzazione Contatore Visite */}
              {viewCount !== null && (
                <div className="inline-flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full text-xs text-gray-500 font-mono border border-gray-200 animate-fadeIn">
                  <Users className="w-3 h-3" />
                  <span>{viewCount} Explorers Joined</span>
                </div>
              )}
            </div>
          </div>
        </div>
      </footer>

      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
          animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .animate-spin-slow {
          animation: spin 3s linear infinite;
        }
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `}</style>
    </div>
  );
}